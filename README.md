# eBPF Instruction Stream Extractor

## Prerequisite

- Linux Kernel Headers with BPF support
- libelf



## Usage

```shell
sh build.sh <ebpf source code path> <ebpf main section name>
```


Example Output:

```shell
sh build.sh example_filters/ebpf_filter.c section_name

object file name: example_filters/ebpf_filter
section name: section_name

instruction stream:
{
    {0xb7, 0x0, 0x0, 0x2}, 
    {0x1261, 0x50, 0x0, 0x0}, 
    {0x1161, 0x4c, 0x0, 0x0}, 
    {0x107, 0x0, 0x0, 0xe}, 
    {0x212d, 0xe, 0x0, 0x0}, 
    {0x1b7, 0x0, 0x0, 0xa}, 
    {0x1a6b, 0xf0, 0xff, 0x0}, 
    {0x118, 0x0, 0x0, 0x75206e61}, 
    {0x0, 0x0, 0x0, 0x75253a70}, 
    {0x1a7b, 0xe8, 0xff, 0x0}, 
    {0x118, 0x0, 0x0, 0x74736554}, 
    {0x0, 0x0, 0x0, 0x656c6320}, 
    {0x1a7b, 0xe0, 0xff, 0x0}, 
    {0xa1bf, 0x0, 0x0, 0x0}, 
    {0x107, 0x0, 0x0, 0xffffffe0}, 
    {0x2b7, 0x0, 0x0, 0x12}, 
    {0x3b7, 0x0, 0x0, 0x8}, 
    {0x85, 0x0, 0x0, 0x6}, 
    {0xb7, 0x0, 0x0, 0x0}, 
    {0x95, 0x0, 0x0, 0x0}, 
};

number of instructions: 20

```

## Why is this tool useful?

We can directly load eBPF programs into the kernel without heavy object files!
All parameters in the below code are supplied by this tool!

```C
char license[ELF_MAX_LICENSE_LEN] = "GPL";
int filter_len = 20;
struct bpfinstr filter[] = {
		{0xb7, 0x0, 0x0, 0x2},
		{0x1261, 0x50, 0x0, 0x0},
		{0x1161, 0x4c, 0x0, 0x0},
		{0x107, 0x0, 0x0, 0xe},
		{0x212d, 0xe, 0x0, 0x0},
		{0x1b7, 0x0, 0x0, 0xa},
		{0x1a6b, 0xf0, 0xff, 0x0},
		{0x118, 0x0, 0x0, 0x75206e61},
		{0x0, 0x0, 0x0, 0x75253a70},
		{0x1a7b, 0xe8, 0xff, 0x0},
		{0x118, 0x0, 0x0, 0x74736554},
		{0x0, 0x0, 0x0, 0x656c6320},
		{0x1a7b, 0xe0, 0xff, 0x0},
		{0xa1bf, 0x0, 0x0, 0x0},
		{0x107, 0x0, 0x0, 0xffffffe0},
		{0x2b7, 0x0, 0x0, 0x12},
		{0x3b7, 0x0, 0x0, 0x8},
		{0x85, 0x0, 0x0, 0x6},
		{0xb7, 0x0, 0x0, 0x0},
		{0x95, 0x0, 0x0, 0x0},
};

union bpf_attr attr = {
    .prog_type = 3,
    .insns = (uintptr_t)filter,
    .insn_cnt = filter_len,
    .license = (uintptr_t)license
};

int fd = syscall(__NR_bpf, BPF_PROG_LOAD, &attr, sizeof(attr));
```

## Limitations

No BPF map support!